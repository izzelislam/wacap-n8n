"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.establishExecutionContext = void 0;
const assertions_1 = require("../utils/assertions");
const establishExecutionContext = async (workflow, runExecutionData, additionalData, mode) => {
    (0, assertions_1.assertExecutionDataExists)(runExecutionData.executionData, workflow, additionalData, mode);
    const executionData = runExecutionData.executionData;
    if (executionData.runtimeData) {
        return;
    }
    executionData.runtimeData = {
        version: 1,
        establishedAt: Date.now(),
        source: mode,
    };
    if (runExecutionData.parentExecution) {
        executionData.runtimeData = {
            ...(runExecutionData.parentExecution.executionContext ?? {}),
            ...executionData.runtimeData,
            parentExecutionId: runExecutionData.parentExecution.executionId,
        };
        return;
    }
    const [startItem] = executionData.nodeExecutionStack;
    if (!startItem) {
        return;
    }
    if (startItem.metadata?.parentExecution?.executionContext) {
        executionData.runtimeData = {
            ...startItem.metadata.parentExecution.executionContext,
            ...executionData.runtimeData,
            parentExecutionId: startItem.metadata.parentExecution.executionId,
        };
        return;
    }
};
exports.establishExecutionContext = establishExecutionContext;
//# sourceMappingURL=execution-context.js.map